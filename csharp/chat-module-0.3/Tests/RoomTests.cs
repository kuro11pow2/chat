namespace Tests
{
    public class RoomTests
    {
#if TEST
        [Theory]
#endif
        [InlineData(@"0123", @"0123")]
        [InlineData(@"abcxyz", @"abcxyz")]
        [InlineData(@"@!#$%^()[]", @"@!#$%^()[]")]
        [InlineData(@"가나다뀕팛", @"가나다뀕팛")]
        [InlineData(@"😂🤣⛴🛬🎁", @"😂🤣⛴🛬🎁")]
        [InlineData(@"1111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000999", @"1111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000999")]
        [InlineData(@"1234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234", @"1234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234")]
        public static async Task LocalRoomTest(string input, string expected)
        {
            int port = 1234;
            int userCount = 20;

            Room room = new Room("room0", port);
            _ = room.Run();
            _ = room.RunMonitor();

            List<User> users = new List<User>();
            for (int i = 0; i < userCount; i++)
            {
                IConnectionContext context = new ConnectionContext("127.0.0.1", port);
                User user = new User(context);
                await user.Connect();
                users.Add(new User(context));
            }

            while (room.UserCount < userCount) 
            {
                await Task.Delay(1000);
            }

            IMessage message = new Utf8Message();
            message.SetMessage(input);

            List<Task> tasks = new List<Task>();

            for (int i = 0; i < users.Count; i++)
            {
                await users[i].Send(message);

                for (int j = 0; j < users.Count; j++)
                {
                    var output = await users[j].Receive();
                    var output_message = output.GetMessage();
                    Assert.Equal(expected, output_message);
                }
            }

            foreach (var user in users)
            {
                user.Disconnect();
            }
            
        }
    }
}