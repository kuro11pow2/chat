namespace Tests
{
    public class RoomQTests
    {
        [Theory]
        [InlineData(@"0123", @"0123")]
        [InlineData(@"abcxyz", @"abcxyz")]
        [InlineData(@"@!#$%^()[]", @"@!#$%^()[]")]
        [InlineData(@"가나다뀕팛", @"가나다뀕팛")]
        [InlineData(@"😂🤣⛴🛬🎁", @"😂🤣⛴🛬🎁")]
        [InlineData(@"1111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000999", @"1111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000999")]
        [InlineData(@"1234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234", @"1234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234")]
        public static async Task LocalRoomQTest(string input, string expected)
        {
            Config config = new();
            int userCount = 30;

            RoomQ room = new(config.Port);
            _ = room.Run();

            List<User> users = new();
            for (int i = 0; i < userCount; i++)
            {
                IConnectionContext context = new ConnectionContext("127.0.0.1", config.Port);
                User user = new(context);
                await user.Connect();
                users.Add(new User(context));
            }

            while (room.Status.CurrentUserCount < userCount)
            {
                await Task.Delay(10);
            }

            IMessage message = new Utf8Message();
            message.SetMessage(input);

            for (int i = 0; i < users.Count; i++)
            {
                int idx = i;
                await users[idx].Send(message);
            }
            
            List<Task> tasks = new();
            for (int i = 0; i < users.Count; i++)
            {
                for (int j = 0; j < users.Count; j++)
                {
                    int idx = j;
                    tasks.Add(Task.Run(async () =>
                    {
                        var output = await users[idx].Receive();
                        var output_message = output.GetMessage();
                        try
                        {
                            Assert.Equal(expected, output_message);
                        }
                        catch
                        {
                            throw;
                        }
                    }));
                }
            }
            await Task.WhenAll(tasks);

            foreach (var user in users)
            {
                user.Disconnect();
            }

            room.Close();
        }

#if !TEST
        [Theory]
#endif
        [InlineData(@"0123", @"0123")]
        [InlineData(@"abcxyz", @"abcxyz")]
        [InlineData(@"@!#$%^()[]", @"@!#$%^()[]")]
        [InlineData(@"가나다뀕팛", @"가나다뀕팛")]
        [InlineData(@"😂🤣⛴🛬🎁", @"😂🤣⛴🛬🎁")]
        [InlineData(@"1111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000999", @"1111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000111100001111000011110000999")]
        [InlineData(@"1234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234", @"1234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234")]
        public static async Task RemoteRoomQTest(string input, string expected)
        {
            Config config = new();
            int userCount = 50;

            List<User> users = new();
            for (int i = 0; i < userCount; i++)
            {
                IConnectionContext context = new ConnectionContext("192.168.0.53", config.Port);
                User user = new(context);
                await user.Connect();
                users.Add(new User(context));
            }

            IMessage message = new Utf8Message();
            message.SetMessage(input);

            for (int i = 0; i < users.Count; i++)
            {
                int idx = i;
                await users[idx].Send(message);
            }

            for (int i = 0; i < users.Count; i++)
            {
                List<Task> tasks = new();

                for (int j = 0; j < users.Count; j++)
                {
                    int idx = j;
                    tasks.Add(Task.Run(async () =>
                    {
                        var output = await users[idx].Receive();
                        var output_message = output.GetMessage();
                        try
                        {
                            Assert.Equal(expected, output_message);
                        }
                        catch
                        {
                            throw;
                        }
                    }));
                }

                await Task.WhenAll(tasks);
            }

            foreach (var user in users)
            {
                user.Disconnect();
            }
        }
    }
}